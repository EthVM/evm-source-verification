{"language":"Solidity","settings":{"libraries":{},"metadata":{"useLiteralContent":true},"optimizer":{"enabled":true,"runs":200},"remappings":[],"outputSelection":{"*":{"*":["*"],"":["*"]}}},"sources":{"InstaAaveResolver.sol":{"content":"pragma solidity ^0.6.0;\r\npragma experimental ABIEncoderV2;\r\n\r\ninterface AaveInterface {\r\n    function getUserReserveData(address _reserve, address _user) external view returns (\r\n        uint256 currentATokenBalance,\r\n        uint256 currentBorrowBalance,\r\n        uint256 principalBorrowBalance,\r\n        uint256 borrowRateMode,\r\n        uint256 borrowRate,\r\n        uint256 liquidityRate,\r\n        uint256 originationFee,\r\n        uint256 variableBorrowIndex,\r\n        uint256 lastUpdateTimestamp,\r\n        bool usageAsCollateralEnabled\r\n    );\r\n\r\n    function getReserveConfigurationData(address _reserve)\r\n    external\r\n    view\r\n    returns (\r\n        uint256 ltv,\r\n        uint256 liquidationThreshold,\r\n        uint256 liquidationBonus,\r\n        address interestRateStrategyAddress,\r\n        bool usageAsCollateralEnabled,\r\n        bool borrowingEnabled,\r\n        bool stableBorrowRateEnabled,\r\n        bool isActive\r\n    );\r\n\r\n    function getUserAccountData(address _user) external view returns (\r\n        uint256 totalLiquidityETH,\r\n        uint256 totalCollateralETH,\r\n        uint256 totalBorrowsETH,\r\n        uint256 totalFeesETH,\r\n        uint256 availableBorrowsETH,\r\n        uint256 currentLiquidationThreshold,\r\n        uint256 ltv,\r\n        uint256 healthFactor\r\n    );\r\n}\r\n\r\ninterface AaveProviderInterface {\r\n    function getLendingPool() external view returns (address);\r\n    function getLendingPoolCore() external view returns (address);\r\n    function getPriceOracle() external view returns (address);\r\n}\r\n\r\ninterface AavePriceInterface {\r\n    function getAssetPrice(address _asset) external view returns (uint256);\r\n    function getAssetsPrices(address[] calldata _assets) external view returns(uint256[] memory);\r\n    function getSourceOfAsset(address _asset) external view returns(address);\r\n    function getFallbackOracle() external view returns(address);\r\n}\r\n\r\ninterface AaveCoreInterface {\r\n    function getReserveCurrentLiquidityRate(address _reserve) external view returns (uint256);\r\n    function getReserveCurrentVariableBorrowRate(address _reserve) external view returns (uint256);\r\n}\r\n\r\ninterface ChainLinkInterface {\r\n    function latestAnswer() external view returns (int256);\r\n    function decimals() external view returns (uint256);\r\n}\r\n\r\ncontract DSMath {\r\n\r\n    function add(uint x, uint y) internal pure returns (uint z) {\r\n        require((z = x + y) >= x, \"math-not-safe\");\r\n    }\r\n\r\n    function sub(uint x, uint y) internal pure returns (uint z) {\r\n        z = x - y <= x ? x - y : 0;\r\n    }\r\n\r\n    function mul(uint x, uint y) internal pure returns (uint z) {\r\n        require(y == 0 || (z = x * y) / y == x, \"math-not-safe\");\r\n    }\r\n\r\n    uint constant WAD = 10 ** 18;\r\n    uint constant RAY = 10 ** 27;\r\n\r\n    function rmul(uint x, uint y) internal pure returns (uint z) {\r\n        z = add(mul(x, y), RAY / 2) / RAY;\r\n    }\r\n\r\n    function wmul(uint x, uint y) internal pure returns (uint z) {\r\n        z = add(mul(x, y), WAD / 2) / WAD;\r\n    }\r\n\r\n    function rdiv(uint x, uint y) internal pure returns (uint z) {\r\n        z = add(mul(x, RAY), y / 2) / y;\r\n    }\r\n\r\n    function wdiv(uint x, uint y) internal pure returns (uint z) {\r\n        z = add(mul(x, WAD), y / 2) / y;\r\n    }\r\n\r\n}\r\n\r\ncontract AaveHelpers is DSMath {\r\n    /**\r\n     * @dev get Aave Provider Address\r\n    */\r\n    function getAaveProviderAddress() internal pure returns (address) {\r\n        return 0x24a42fD28C976A61Df5D00D0599C34c4f90748c8; //mainnet\r\n        // return 0x506B0B2CF20FAA8f38a4E2B524EE43e1f4458Cc5; //kovan\r\n    }\r\n\r\n    /**\r\n     * @dev get Chainlink ETH price feed Address\r\n    */\r\n    function getChainlinkEthFeed() internal pure returns (address) {\r\n        return 0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419; //mainnet\r\n        // return 0x9326BFA02ADD2366b30bacB125260Af641031331; //kovan\r\n    }\r\n\r\n    struct AaveUserTokenData {\r\n        uint tokenPriceInEth;\r\n        uint tokenPriceInUsd;\r\n        uint supplyBalance;\r\n        uint borrowBalance;\r\n        uint borrowFee;\r\n        uint supplyRate;\r\n        uint borrowRate;\r\n        uint borrowModal;\r\n        bool isCollateral;\r\n        AaveTokenData aaveTokenData;\r\n    }\r\n\r\n    struct AaveUserData {\r\n        uint totalSupplyETH;\r\n        uint totalCollateralETH;\r\n        uint totalBorrowsETH;\r\n        uint totalFeesETH;\r\n        uint availableBorrowsETH;\r\n        uint currentLiquidationThreshold;\r\n        uint ltv;\r\n        uint healthFactor;\r\n        uint ethPriceInUsd;\r\n    }\r\n\r\n    struct AaveTokenData {\r\n        uint ltv;\r\n        uint threshold;\r\n        bool usageAsCollEnabled;\r\n        bool borrowEnabled;\r\n        bool stableBorrowEnabled;\r\n        bool isActive;\r\n    }\r\n\r\n    struct TokenPrice {\r\n        uint priceInEth;\r\n        uint priceInUsd;\r\n    }\r\n\r\n\r\n    function getTokensPrices(AaveProviderInterface AaveProvider, address[] memory tokens) \r\n    internal view returns(TokenPrice[] memory tokenPrices, uint ethPrice) {\r\n        uint[] memory _tokenPrices = AavePriceInterface(AaveProvider.getPriceOracle()).getAssetsPrices(tokens);\r\n        ethPrice = uint(ChainLinkInterface(getChainlinkEthFeed()).latestAnswer());\r\n        tokenPrices = new TokenPrice[](_tokenPrices.length);\r\n        for (uint i = 0; i < _tokenPrices.length; i++) {\r\n            tokenPrices[i] = TokenPrice(\r\n                _tokenPrices[i],\r\n                wmul(_tokenPrices[i], uint(ethPrice) * 10 ** 10)\r\n            );\r\n        }\r\n    }\r\n\r\n    function collateralData(AaveInterface aave, address token) internal view returns(AaveTokenData memory) {\r\n        AaveTokenData memory aaveTokenData;\r\n        (\r\n            aaveTokenData.ltv,\r\n            aaveTokenData.threshold,\r\n            ,\r\n            ,\r\n            aaveTokenData.usageAsCollEnabled,\r\n            aaveTokenData.borrowEnabled,\r\n            aaveTokenData.stableBorrowEnabled,\r\n            aaveTokenData.isActive\r\n        ) = aave.getReserveConfigurationData(token);\r\n        return aaveTokenData;\r\n    }\r\n\r\n    function getTokenData(\r\n        AaveCoreInterface aaveCore,\r\n        AaveInterface aave,\r\n        address user,\r\n        address token,\r\n        uint priceInEth,\r\n        uint priceInUsd)\r\n    internal view returns(AaveUserTokenData memory tokenData) {\r\n        (\r\n            uint supplyBal,\r\n            uint borrowBal,\r\n            ,\r\n            uint borrowModal,\r\n            ,\r\n            ,\r\n            uint fee,\r\n            ,,\r\n            bool isCollateral\r\n        ) = aave.getUserReserveData(token, user);\r\n\r\n        uint supplyRate = aaveCore.getReserveCurrentLiquidityRate(token);\r\n        uint borrowRate = aaveCore.getReserveCurrentVariableBorrowRate(token);\r\n        AaveTokenData memory aaveTokenData = collateralData(aave, token);\r\n\r\n        tokenData = AaveUserTokenData(\r\n            priceInEth,\r\n            priceInUsd,\r\n            supplyBal,\r\n            borrowBal,\r\n            fee,\r\n            supplyRate,\r\n            borrowRate,\r\n            borrowModal,\r\n            isCollateral,\r\n            aaveTokenData\r\n        );\r\n    }\r\n\r\n    function getUserData(AaveInterface aave, address user, uint ethPrice)\r\n    internal view returns (AaveUserData memory userData) {\r\n        (\r\n            uint totalSupplyETH,\r\n            uint totalCollateralETH,\r\n            uint totalBorrowsETH,\r\n            uint totalFeesETH,\r\n            uint availableBorrowsETH,\r\n            uint currentLiquidationThreshold,\r\n            uint ltv,\r\n            uint healthFactor\r\n        ) = aave.getUserAccountData(user);\r\n\r\n        userData = AaveUserData(\r\n            totalSupplyETH,\r\n            totalCollateralETH,\r\n            totalBorrowsETH,\r\n            totalFeesETH,\r\n            availableBorrowsETH,\r\n            currentLiquidationThreshold,\r\n            ltv,\r\n            healthFactor,\r\n            ethPrice\r\n        );\r\n    }\r\n}\r\n\r\ncontract Resolver is AaveHelpers {\r\n    function getPosition(address user, address[] memory tokens) public view returns(AaveUserTokenData[] memory, AaveUserData memory) {\r\n        AaveProviderInterface AaveProvider = AaveProviderInterface(getAaveProviderAddress());\r\n        AaveInterface aave = AaveInterface(AaveProvider.getLendingPool());\r\n        AaveCoreInterface aaveCore = AaveCoreInterface(AaveProvider.getLendingPoolCore());\r\n\r\n        AaveUserTokenData[] memory tokensData = new AaveUserTokenData[](tokens.length);\r\n        (TokenPrice[] memory tokenPrices, uint ethPrice) = getTokensPrices(AaveProvider, tokens);\r\n        for (uint i = 0; i < tokens.length; i++) {\r\n            tokensData[i] = getTokenData(aaveCore, aave, user, tokens[i], tokenPrices[i].priceInEth, tokenPrices[i].priceInUsd);\r\n        }\r\n        return (tokensData, getUserData(aave, user, ethPrice));\r\n    }\r\n}\r\n\r\ncontract InstaAaveResolver is Resolver {\r\n    string public constant name = \"Aave-Resolver-v1.2\";\r\n}"}}}